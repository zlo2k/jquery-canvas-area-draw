(function(d){d.fn.canvasAreaDraw=function(d){this.each(function(f,c){w.apply(c,[f,c,d])})};var w=function(r,f,c){var m,h=!1,n=1;r=d.extend({imageUrl:d(this).attr("data-image-url")},c);c=d(f).val().replace(/[^0-9,]/ig,"");var b=c.length?c.split(",").map(function(a){return parseInt(a,10)}):[];c=d('<button type="button" class="btn"><i class="icon-trash"></i>\u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c</button>');var l=d("<canvas>");var g=l[0].getContext("2d");var e=new Image;var t=function(){if(l[0].scrollWidth!==
e.naturalWidth){n=l[0].scrollWidth/e.naturalWidth;for(var a=0;a<b.length;a++)b[a]*=n}l.attr("height",Math.round(e.naturalHeight*n)).attr("width",l[0].scrollWidth);p()};d(e).load(t);e.src=r.imageUrl;e.loaded&&t();l.css({background:"url("+e.src+")","background-size":"cover"});d(f).after("<br>",l,"<br>",c);var u=function(a){b[m]=Math.round(a.offsetX);b[m+1]=Math.round(a.offsetY);p()};var x=function(a){h||(h={x:Math.round(a.offsetX),y:Math.round(a.offsetY)});a={x:Math.round(a.offsetX),y:Math.round(a.offsetY)};
for(var k=0;k<b.length;k++)b[k]=a.x-h.x+b[k],b[++k]=a.y-h.y+b[k];h=a;p()};var p=function(){g.canvas.width=g.canvas.width;q();if(!(2>b.length)){g.globalCompositeOperation="destination-over";g.fillStyle="rgb(255,255,255)";g.strokeStyle="rgb(255,20,20)";g.lineWidth=1;if(6<=b.length){var a=getCenter();g.fillRect(a.x-4,a.y-4,8,8)}g.beginPath();g.moveTo(b[0],b[1]);for(a=0;a<b.length;a+=2)g.fillRect(b[a]-2,b[a+1]-2,4,4),g.strokeRect(b[a]-2,b[a+1]-2,4,4),2<b.length&&1<a&&g.lineTo(b[a],b[a+1]);g.closePath();
g.fillStyle="rgba(255,0,0,0.3)";g.fill();g.stroke()}};var q=function(){if(1===n)d(f).val(b.join(","));else{for(var a=[],k=0;k<b.length;k++)a[k]=Math.round(b[k]/n);d(f).val(a.join(","))}};getCenter=function(){var a=[];for(e=0;e<b.length;e++)a.push({x:b[e],y:b[++e]});var k=a[0],d=a[a.length-1];k.x==d.x&&k.y==d.y||a.push(k);var v=d=k=0,g=a.length,c,e=0;for(c=g-1;e<g;c=e++){var f=a[e];c=a[c];var h=f.x*c.y-c.x*f.y;k+=h;d+=(f.x+c.x)*h;v+=(f.y+c.y)*h}h=3*k;return{x:d/h,y:v/h}};d(f).on("change",function(){var a=
d(f).val().replace(/[^0-9,]/ig,"");b=a.length?a.split(",").map(function(a){return parseInt(a,10)}):[];p()});d(document).find(c).click(function(){b=[];p()});d(document).find(l).on("mousedown",function(a){var k=b.length;if(3===a.which)return!1;a.preventDefault();var c=a.offsetX;a=a.offsetY;if(6<=b.length){var e=getCenter();g.fillRect(e.x-4,e.y-4,8,8);var f=Math.sqrt(Math.pow(c-e.x,2)+Math.pow(a-e.y,2));if(6>f)return h=!1,d(this).on("mousemove",x),!1}for(e=0;e<b.length;e+=2)if(f=Math.sqrt(Math.pow(c-
b[e],2)+Math.pow(a-b[e+1],2)),6>f)return m=e,d(this).on("mousemove",u),!1;for(e=0;e<b.length;e+=2)1<e&&(f=y(c,a,b[e],b[e+1],b[e-2],b[e-1],!0),6>f&&(k=e));b.splice(k,0,c,a);m=k;d(this).on("mousemove",u);p();q();return!1});d(document).find(l).on("contextmenu",function(a){a.preventDefault();var e=a.offsetX;a=a.offsetY;for(var c=0;c<b.length;c+=2)if(dis=Math.sqrt(Math.pow(e-b[c],2)+Math.pow(a-b[c+1],2)),6>dis){b.splice(c,2);p();q();break}return!1});d(document).find(l).on("mouseup",function(){d(this).off("mousemove");
q();m=null})};d(document).ready(function(){d(".canvas-area[data-image-url]").canvasAreaDraw()});var y=function(d,f,c,m,h,n,b){function l(b,c,d,f){return Math.sqrt((b-=d)*b+(c-=f)*c)}if(b&&!(b=function(b,c,d,f,g,h){if(!(g-d))return{x:d,y:c};if(!(h-f))return{x:b,y:f};var a,e=-1/((h-f)/(g-d));return{x:a=(g*(b*e-c+f)+d*(b*-e+c-h))/(e*(g-d)+f-h),y:e*a-e*b+c}}(d,f,c,m,h,n),b.x>=Math.min(c,h)&&b.x<=Math.max(c,h)&&b.y>=Math.min(m,n)&&b.y<=Math.max(m,n)))return c=l(d,f,c,m),d=l(d,f,h,n),c>d?d:c;b=m-n;var g=
h-c;return Math.abs(b*d+g*f+(c*n-m*h))/Math.sqrt(b*b+g*g)}})(jQuery);