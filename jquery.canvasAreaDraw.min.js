(function(c){c.fn.canvasAreaDraw=function(c){this.each(function(f,d){w.apply(d,[f,d,c])})};var w=function(t,f,d){var m,l=!1,g=1;t=c.extend({imageUrl:c(this).attr("data-image-url")},d);d=c(f).val().replace(/[^0-9,]/ig,"");var b=d.length?d.split(",").map(function(a){return parseInt(a,10)}):[];d=c('<button type="button" class="btn"><i class="icon-trash"></i>\u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c</button>');var n=c("<canvas>");var e=n[0].getContext("2d");var h=new Image;var u=function(){if(n[0].clientWidth!==
h.naturalWidth){g=h.naturalWidth/n[0].clientWidth;for(var a=0;a<b.length;a++)b[a]*=g}n.attr("height",h.naturalHeight).attr("width",h.naturalWidth);q()};c(h).load(u);h.src=t.imageUrl;h.loaded&&u();n.css({background:"url("+h.src+")","background-size":"cover"});c(f).after("<br>",n,"<br>",d);var v=function(a){a.offsetX||(a.offsetX=a.pageX-c(a.target).offset().left,a.offsetY=a.pageY-c(a.target).offset().top);b[m]=Math.round(a.offsetX)*g;b[m+1]=Math.round(a.offsetY)*g;q()};var x=function(a){a.offsetX||
(a.offsetX=a.pageX-c(a.target).offset().left,a.offsetY=a.pageY-c(a.target).offset().top);l||(l={x:Math.round(a.offsetX),y:Math.round(a.offsetY)});a={x:Math.round(a.offsetX),y:Math.round(a.offsetY)};for(var p=0;p<b.length;p++)b[p]=a.x-l.x+b[p],b[++p]=a.y-l.y+b[p];l=a;q()};var q=function(){e.canvas.width=e.canvas.width;r();if(!(2>b.length)){e.globalCompositeOperation="destination-over";e.fillStyle="rgb(255,255,255)";e.strokeStyle="rgb(255,20,20)";e.lineWidth=1;if(6<=b.length){var a=getCenter();e.fillRect(a.x-
4,a.y-4,8,8)}e.beginPath();e.moveTo(b[0],b[1]);for(a=0;a<b.length;a+=2)e.fillRect(b[a]-2,b[a+1]-2,4,4),e.strokeRect(b[a]-2,b[a+1]-2,4,4),2<b.length&&1<a&&e.lineTo(b[a],b[a+1]);e.closePath();e.fillStyle="rgba(255,0,0,0.3)";e.fill();e.stroke()}};var r=function(){if(1===g)c(f).val(b.join(","));else{for(var a=[],p=0;p<b.length;p++)a[p]=Math.round(b[p]/g);c(f).val(a.join(","))}};getCenter=function(){var a=[];for(g=0;g<b.length;g++)a.push({x:b[g],y:b[++g]});var c=a[0],e=a[a.length-1];c.x==e.x&&c.y==e.y||
a.push(c);var k=e=c=0,d=a.length,h,g=0;for(h=d-1;g<d;h=g++){var f=a[g];h=a[h];var l=f.x*h.y-h.x*f.y;c+=l;e+=(f.x+h.x)*l;k+=(f.y+h.y)*l}l=3*c;return{x:e/l,y:k/l}};c(f).on("change",function(){var a=c(f).val().replace(/[^0-9,]/ig,"");b=a.length?a.split(",").map(function(a){return parseInt(a,10)}):[];q()});c(document).find(d).click(function(){b=[];q()});c(document).find(n).on("mousedown",function(a){var h=b.length;if(3===a.which)return!1;a.preventDefault();a.offsetX||(a.offsetX=a.pageX-c(a.target).offset().left,
a.offsetY=a.pageY-c(a.target).offset().top);var d=a.offsetX*g;a=a.offsetY*g;if(6<=b.length){var k=getCenter();e.fillRect(k.x-4,k.y-4,8,8);var f=Math.sqrt(Math.pow(d-k.x,2)+Math.pow(a-k.y,2));if(6>f)return l=!1,c(this).on("mousemove",x),!1}for(k=0;k<b.length;k+=2)if(f=Math.sqrt(Math.pow(d-b[k],2)+Math.pow(a-b[k+1],2)),6>f)return m=k,c(this).on("mousemove",v),!1;for(k=0;k<b.length;k+=2)1<k&&(f=y(d,a,b[k],b[k+1],b[k-2],b[k-1],!0),6>f&&(h=k));b.splice(h,0,Math.round(d),Math.round(a));m=h;c(this).on("mousemove",
v);q();r();return!1});c(document).find(n).on("contextmenu",function(a){a.preventDefault();a.offsetX||(a.offsetX=a.pageX-c(a.target).offset().left,a.offsetY=a.pageY-c(a.target).offset().top);var h=a.offsetX;a=a.offsetY;for(var d=0;d<b.length;d+=2)if(dis=Math.sqrt(Math.pow(h-b[d],2)+Math.pow(a-b[d+1],2)),6>dis){b.splice(d,2);q();r();break}return!1});c(document).find(n).on("mouseup",function(){c(this).off("mousemove");r();m=null})};c(document).ready(function(){c(".canvas-area[data-image-url]").canvasAreaDraw()});
var y=function(c,f,d,m,l,g,b){function n(b,c,d,e){return Math.sqrt((b-=d)*b+(c-=e)*c)}if(b&&!(b=function(b,c,d,e,f,g){if(!(f-d))return{x:d,y:c};if(!(g-e))return{x:b,y:e};var a,h=-1/((g-e)/(f-d));return{x:a=(f*(b*h-c+e)+d*(b*-h+c-g))/(h*(f-d)+e-g),y:h*a-h*b+c}}(c,f,d,m,l,g),b.x>=Math.min(d,l)&&b.x<=Math.max(d,l)&&b.y>=Math.min(m,g)&&b.y<=Math.max(m,g)))return d=n(c,f,d,m),c=n(c,f,l,g),d>c?c:d;b=m-g;var e=l-d;return Math.abs(b*c+e*f+(d*g-m*l))/Math.sqrt(b*b+e*e)}})(jQuery);